<?php


namespace Iugu\Traits;


use Exception;
use GuzzleHttp\Exception\ClientException;
use GuzzleHttp\Exception\GuzzleException;

trait IuguBaseTrait
{
    use GuzzleRequestTrait;

    /**
     * @param array $options
     * @return mixed
     * @throws GuzzleException
     */
    public function sync(array $options = [])
    {
        try{
            $this->saveRequest();
            return parent::save($options); // TODO: Change the autogenerated stub
        } catch (ClientException | Exception $exception) {
            throw $exception;
        }
    }

    /**
     * @param array $options
     * @return mixed
     * @throws GuzzleException
     */
    public function syncOrFail(array $options=[])
    {
        try{
            $this->saveRequest();
            return parent::saveOrFail($options); // TODO: Change the autogenerated stub
        } catch (ClientException | Exception $exception) {
            throw $exception;
        }
    }

    /**
     * @return mixed
     */
    public function syncDelete()
    {
        try{
            $this->deleteRequest();
            return parent::delete(); // TODO: Change the autogenerated stub
        } catch (ClientException | Exception $exception) {
            throw $exception;
        }
    }

    /**
     * @return mixed
     * @throws GuzzleException
     */
    public function saveRequest()
    {
        try{
            $response = null;
            if(empty($this->iugu_id))
            {
                $response=$this->postRequest();
            } else {
                $response=$this->updateRequest();
            }
            $this->iugu_id = $response->id;
            $collect=collect($response)->toArray();
            $this->fill($collect);
            $this->saveOrFail();
            return $this;
        } catch (ClientException $exception) {
            throw $exception;
        }
    }

    /**
     * @param array $optionalHeaders
     * @return mixed
     */
    public function postRequest($optionalHeaders = [])
    {
        $data = collect($this->toArray())->except(['id','iugu_id'])->toJson();
        return $this->decodeResponse($this->createRequest()->post($this->getBasePath(), [
            'json' => $this->toArray()
        ]));
    }

    public function updateRequest()
    {
        $data= collect([$this->toArray()])
            ->except(['id',"iugu_id",'deleted_at','created_at','updated_at','customer_id','custom_variables']);
        return $this->decodeResponse($this->createRequest()->put($this->getBasePath(), [
            'json' => $this->toArray()
        ]));
    }

    public function deleteRequest()
    {
        $response=$this->decodeResponse($this->createRequest()->delete($this->getBasePath()));
        $this->iugu_id = $response->id;
        $collect=collect($response)->toArray();
        $this->fill($collect);
        $this->saveOrFail();
        return $this;
    }

    public function getIuguDataAttribute()
    {
        return $this->decodeResponse($this->createRequest()->get($this->getBasePath()));
    }
}
